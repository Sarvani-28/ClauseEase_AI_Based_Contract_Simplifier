<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ClauseEase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}" defer></script>
    <style>
        [data-theme="dark"] { --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d; --text-primary: #ffffff; --text-secondary: #cccccc; --border-color: #404040; --chart-grid-color: rgba(255, 255, 255, 0.1); }
        [data-theme="light"] { --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --text-primary: #000000; --text-secondary: #6c757d; --border-color: #dee2e6; --chart-grid-color: rgba(0, 0, 0, 0.05); }
        body { background-color: var(--bg-primary); color: var(--text-primary); transition: all 0.3s ease; font-family: sans-serif; }
        .navbar, .card, .form-control, .form-select, .dropdown-menu { background-color: var(--bg-secondary) !important; color: var(--text-primary) !important; border-color: var(--border-color) !important; }
        .dropdown-item { color: var(--text-primary) !important; }
        .dropdown-item:hover { background-color: var(--border-color) !important; }
        .table { color: var(--text-primary) !important; }
        .card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); border: none; }
        .stat-card { border-left: 4px solid; transition: transform 0.2s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card.users { border-left-color: #667eea; }
        .stat-card.documents { border-left-color: #764ba2; }
        .stat-card.active { border-left-color: #ff6b6b; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .table, .table th, .table td { color: var(--text-primary); border-color: var(--border-color); }
        [data-theme="light"] .stat-card .fa-users { color: #667eea; }
        [data-theme="light"] .stat-card .fa-file-contract { color: #764ba2; }
        [data-theme="light"] .stat-card .fa-chart-line { color: #ff6b6b; }
        [data-theme="dark"] .stat-card .fa-users, [data-theme="dark"] .stat-card .fa-file-contract, [data-theme="dark"] .stat-card .fa-chart-line { color: #ffffff; opacity: 0.8; }
        .text-muted { color: var(--text-secondary) !important; }
        .card-header h5 i { color: var(--text-secondary); margin-right: 0.5rem; }
        .card-header { background-color: var(--bg-secondary) !important; border-bottom: 1px solid var(--border-color); }
        .table-hover tbody tr:hover { background-color: var(--border-color); }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
       <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-crown me-2"></i> ClauseEase Admin
            </a>
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-shield me-1"></i> {{ current_user.username }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('landing') }}"> <i class="fas fa-tachometer-alt me-2"></i>User Dashboard </a></li>
                        <li><a class="dropdown-item" href="#"> <i class="fas fa-cog me-2"></i>Settings </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}"> <i class="fas fa-sign-out-alt me-2"></i>Logout </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <h2 class="mb-4">Admin Dashboard</h2>

        <!-- Stat Cards Row -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card stat-card users mb-3 mb-md-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div> <h4 class="mb-0">{{ total_users }}</h4> <p class="text-muted mb-0">Total Users</p> </div>
                            <div class="align-self-center"> <i class="fas fa-users fa-2x"></i> </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card documents mb-3 mb-md-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div> <h4 class="mb-0">{{ total_documents }}</h4> <p class="text-muted mb-0">Total Documents</p> </div>
                            <div class="align-self-center"> <i class="fas fa-file-contract fa-2x"></i> </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card stat-card active mb-3 mb-md-0">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div> <h4 class="mb-0">{{ active_today }}</h4> <p class="text-muted mb-0">Users Active Today</p> </div>
                            <div class="align-self-center"> <i class="fas fa-chart-line fa-2x"></i> </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row - Side by Side -->
        <div class="row mb-4">
            <!-- User Registrations Per Day (Last 7 Days) -->
            <div class="col-lg-6 mb-4 mb-lg-0">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"> <i class="fas fa-user-plus"></i>User Registrations Per Day (Last 7 Days) </h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="chart-container flex-grow-1">
                            <!-- Removed data-* attribute -->
                            <canvas id="registrationChart"> </canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Documents Processed Per Week (Last 4 Weeks) -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0"> <i class="fas fa-calendar-week"></i>Documents Processed Per Week (Last 4 Weeks) </h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="chart-container flex-grow-1">
                             <!-- Removed data-* attribute -->
                            <canvas id="processedDocsWeeklyChart"> </canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Most Active Users Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                         <h5 class="mb-0"> <i class="fas fa-trophy"></i>Most Active Users (Top 5) </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr> <th>Username</th> <th>Documents Created</th> <th>Activity Level</th> </tr>
                                </thead>
                                <tbody>
                                    {% for user in active_users %}
                                    <tr>
                                        <td>{{ user.username }}</td>
                                        <td>{{ user.doc_count }}</td>
                                        <td>
                                            {% if user.doc_count >= 50 %} <span class="badge bg-danger">Very High</span>
                                            {% elif user.doc_count >= 20 %} <span class="badge bg-success">High</span>
                                            {% elif user.doc_count >= 10 %} <span class="badge bg-primary">Medium</span>
                                            {% elif user.doc_count >= 1 %} <span class="badge bg-info text-dark">Low</span>
                                            {% else %} <span class="badge bg-secondary">None</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                     <tr> <td colspan="3" class="text-center text-muted">No user activity recorded yet.</td> </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const isDarkMode = document.documentElement.dataset.theme === 'dark';
            const textColor = isDarkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.6)';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
            const primaryColor = '#667eea';
            const secondaryColor = '#764ba2';

            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            // --- Registration Chart (Line) ---
            const registrationCtx = document.getElementById('registrationChart')?.getContext('2d');
            // --- MODIFIED --- Get data directly from Jinja variable ---
            const registrationData = {{ registration_data | tojson | safe }};

            if (registrationCtx && registrationData) { // Check if data exists
                try {
                    if (!Array.isArray(registrationData)) throw new Error("Registration data is not an array");

                    const gradient = registrationCtx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, 'rgba(102, 126, 234, 0.5)');
                    gradient.addColorStop(1, 'rgba(102, 126, 234, 0.05)');

                    new Chart(registrationCtx, {
                        type: 'line',
                        data: {
                            labels: registrationData.map(item => item.date ? item.date.substring(5) : 'N/A'),
                            datasets: [{
                                label: 'Registrations', data: registrationData.map(item => item.count ?? 0),
                                borderColor: primaryColor, backgroundColor: gradient, borderWidth: 2.5, fill: true, tension: 0.4,
                                pointBackgroundColor: primaryColor, pointBorderColor: '#fff', pointRadius: 4, pointHoverRadius: 6, pointHoverBorderWidth: 2
                            }]
                        },
                        options: { // Keep previous enhanced options
                             responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1, padding: 10 }, grid: { color: gridColor, drawBorder: false } }, x: { ticks: { color: textColor, padding: 10 }, grid: { display: false, drawBorder: false } } }, plugins: { legend: { display: false }, tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)', titleColor: '#fff', bodyColor: '#fff', padding: 10, cornerRadius: 4, displayColors: false } }, interaction: { intersect: false, mode: 'index' }
                         }
                    });
                } catch (e) { console.error("Error initializing registration chart:", e); registrationCtx.canvas.parentElement.innerHTML = '<p class="text-danger text-center small">Error loading chart data.</p>'; }
            } else { console.error("Canvas element or data for registration chart not found."); }

            // --- Documents Processed Chart (Bar) ---
            const processedDocsWeeklyCtx = document.getElementById('processedDocsWeeklyChart')?.getContext('2d');
            // --- MODIFIED --- Get data directly from Jinja variable ---
            const processedDocsWeeklyData = {{ processed_docs_weekly_data | tojson | safe }};

             if (processedDocsWeeklyCtx && processedDocsWeeklyData) { // Check if data exists
                 try {
                     if (!Array.isArray(processedDocsWeeklyData)) throw new Error("Weekly documents data is not an array");

                     const maxDocsCount = Math.max(0, ...processedDocsWeeklyData.map(item => item.count ?? 0));
                     const yStepSize = Math.max(1, Math.ceil(maxDocsCount / 5));

                     new Chart(processedDocsWeeklyCtx, {
                         type: 'bar',
                         data: {
                             labels: processedDocsWeeklyData.map(item => `Week ${item.week ?? 'N/A'}`),
                             datasets: [{
                                 label: 'Documents Processed', data: processedDocsWeeklyData.map(item => item.count ?? 0),
                                 backgroundColor: 'rgba(118, 75, 162, 0.7)', borderColor: 'rgba(118, 75, 162, 1)',
                                 borderWidth: 1, borderRadius: 5, borderSkipped: false, barPercentage: 0.7, categoryPercentage: 0.8
                             }]
                         },
                         options: { // Keep previous enhanced options
                              responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: yStepSize, padding: 10 }, grid: { color: gridColor, drawBorder: false } }, x: { ticks: { color: textColor, padding: 10 }, grid: { display: false, drawBorder: false } } }, plugins: { legend: { display: false }, tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)', titleColor: '#fff', bodyColor: '#fff', padding: 10, cornerRadius: 4, displayColors: false } }
                          }
                     });
                 } catch (e) { console.error("Error initializing weekly documents chart:", e); processedDocsWeeklyCtx.canvas.parentElement.innerHTML = '<p class="text-danger text-center small">Error loading chart data.</p>'; }
             } else { console.error("Canvas element or data for weekly documents chart not found."); }
        });
    </script>
</body>
</html>